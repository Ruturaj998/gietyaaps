<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GietYchat</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;}
.container { width: 100%; max-width: 500px; margin-top: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 20px;}
h2{text-align:center;}
input, button{width:100%; padding:10px; margin:5px 0; border-radius:6px; border:1px solid #ccc;}
button{background:#4CAF50; color:white; cursor:pointer; border:none;}
button:hover{background:#45a049;}
.chat-box{border:1px solid #ccc; height:300px; overflow-y:auto; margin-bottom:10px; padding:10px; background:#fafafa;}
.chat-bubble{margin:5px 0; padding:8px 10px; border-radius:8px; background:#e0e0e0;}
.chat-bubble.self{background:#4caf50; color:white; text-align:right;}
</style>
</head>
<body>
<div class="container">
  <h2>üöÄ GietYchat</h2>

  <!-- Auth Section -->
  <div id="auth-section">
    <input type="email" id="email" placeholder="Email"/>
    <input type="password" id="password" placeholder="Password"/>
    <button id="loginBtn">Login</button>
    <button id="signupBtn">Register</button>
  </div>

  <!-- Chat Section -->
  <div id="chat-section" style="display:none;">
    <p>Welcome, <span id="user-email"></span></p>
    <button id="logoutBtn">Logout</button>

    <h3>üåç Public Chat</h3>
    <div class="chat-box" id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message..."/>
    <button id="sendBtn">Send</button>

    <h3>üîí Private Room</h3>
    <input type="text" id="roomId" placeholder="Room ID"/>
    <input type="password" id="roomPassword" placeholder="Room Password"/>
    <button id="createRoomBtn">Create Room</button>
    <button id="joinRoomBtn">Join Room</button>

    <div id="privateRoom" style="display:none;">
      <h4>Private Room Messages</h4>
      <div class="chat-box" id="privateMessages"></div>
      <input type="text" id="privateInput" placeholder="Type private message..."/>
      <button id="privateSend">Send Private</button>
    </div>
  </div>
</div>

<script>
  // ‚úÖ Supabase Config
  const SUPABASE_URL = "https://ioyqbbvkmotrolmqpnse.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlveXFiYnZrbW90cm9sbXFwbnNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzA4NDgsImV4cCI6MjA3NDcwNjg0OH0._OIFa6RM0A5joyykPebhW1MFuHVgZrHbwYK47sp2ybk";
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authSection = document.getElementById("auth-section");
  const chatSection = document.getElementById("chat-section");
  const userEmailSpan = document.getElementById("user-email");

  const loginBtn = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const messagesDiv = document.getElementById("messages");

  const roomIdInput = document.getElementById("roomId");
  const roomPassInput = document.getElementById("roomPassword");
  const createRoomBtn = document.getElementById("createRoomBtn");
  const joinRoomBtn = document.getElementById("joinRoomBtn");
  const privateRoomDiv = document.getElementById("privateRoom");
  const privateMessagesDiv = document.getElementById("privateMessages");
  const privateInput = document.getElementById("privateInput");
  const privateSend = document.getElementById("privateSend");

  let currentUser = null;
  let currentRoomId = null;

  // üîê Auth
  signupBtn.onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { error } = await client.auth.signUp({ email, password });
    if (error) alert(error.message);
    else alert("Check email for confirmation!");
  };

  loginBtn.onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if (error) alert(error.message);
    else {
      currentUser = data.user;
      userEmailSpan.innerText = currentUser.email;
      authSection.style.display = "none";
      chatSection.style.display = "block";
      loadMessages();
    }
  };

  logoutBtn.onclick = async () => {
    await client.auth.signOut();
    authSection.style.display = "block";
    chatSection.style.display = "none";
    currentUser = null;
    currentRoomId = null;
    privateRoomDiv.style.display = "none";
  };

  // üåç Public Chat
  async function loadMessages() {
    const { data, error } = await client.from("messages").select("*").order("id");
    if (error) return console.error(error);
    messagesDiv.innerHTML = data.map(m =>
      `<div class="chat-bubble${m.username===currentUser.email?" self":""}">
        <strong>${m.username}</strong>: ${m.message}
      </div>`).join("");
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  sendBtn.onclick = async () => {
    if (!messageInput.value.trim()) return;
    await client.from("messages").insert([{ username: currentUser.email, message: messageInput.value }]);
    messageInput.value = "";
  };

  // Realtime subscription
  client.channel('public:messages')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
      loadMessages();
    }).subscribe();

  // üîí Private Room
  createRoomBtn.onclick = async () => {
    const rid = roomIdInput.value.trim();
    const pwd = roomPassInput.value.trim();
    if (!rid || !pwd) return alert("Enter Room ID and Password");
    await client.from("private_rooms").insert([{ room_id: rid, password: pwd, messages: [] }]);
    alert("Room created!");
  };

  joinRoomBtn.onclick = async () => {
    const rid = roomIdInput.value.trim();
    const pwd = roomPassInput.value.trim();
    const { data, error } = await client.from("private_rooms").select("*").eq("room_id", rid).single();
    if (error) return alert("Room not found");
    if (data.password !== pwd) return alert("Wrong password");
    currentRoomId = rid;
    privateRoomDiv.style.display = "block";
    loadPrivateMessages();
  };

  async function loadPrivateMessages() {
    if (!currentRoomId) return;
    const { data } = await client.from("private_rooms").select("*").eq("room_id", currentRoomId).single();
    privateMessagesDiv.innerHTML = data.messages.map(m =>
      `<div class="chat-bubble${m.username===currentUser.email?" self":""}">
        <strong>${m.username}</strong>: ${m.message}
      </div>`).join("");
    privateMessagesDiv.scrollTop = privateMessagesDiv.scrollHeight;
  }

  privateSend.onclick = async () => {
    if (!privateInput.value.trim()) return;
    const { data } = await client.from("private_rooms").select("*").eq("room_id", currentRoomId).single();
    data.messages.push({ username: currentUser.email, message: privateInput.value });
    await client.from("private_rooms").update({ messages: data.messages }).eq("room_id", currentRoomId);
    privateInput.value = "";
    loadPrivateMessages();
  };
</script>
</body>
</html>
